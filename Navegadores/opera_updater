#!/bin/sh

# Script by www.seguridadwireless.net

SCRIPT_VERSION=20151116

############################################################
## Funciones comunes. Su nombre empieza por f_ ##
############################################################
f_variables(){
	. /opt/wifislax-updaters/Funciones/funciones_updater
}

############################################################
## Funciones propias del script. Su nombre empieza por F_ ##
############################################################
# Definicion de variables
F_variables() {
	ARCH=i386
	PRGNAM=opera
	echo -ne "\033]2;${PRGNAM}_updater\007"
	VERSION=12.16
	RAMA=$(echo $VERSION | sed "s/[.]//g")
	REVNO=1860
	WEB=ftp://ftp.opera.com/pub/opera/linux/$RAMA/$PRGNAM-${VERSION}-${REVNO}.${ARCH}.linux.tar.xz
}

# Creamos directorios extra
F_extradirs(){
mkdir -p $PKG/$HOME/.opera
}

# Si el paquete no existe se descargara de internet
F_download(){
	if [ ! -f $PRGNAM-${VERSION}-${REVNO}.${ARCH}.linux.tar.xz ]; then
	echo ""
	echo "$CYAN"Descargando sources de $PRGNAM-$VERSION"$CIERRE"
	sleep 1
	aria2c -x 3 $WEB
	fi
}

# Descomprimimos el fichero descargado y compilamos
F_compilar(){
rm -rf $PRGNAM-${VERSION}-${REVNO}.${ARCH}.linux
tar xf $PRGNAM-${VERSION}-${REVNO}.${ARCH}.linux.tar.xz
cd $PRGNAM-${VERSION}-${REVNO}.${ARCH}.linux
chown -R root:root .
find -L . \
 \( -perm 777 -o -perm 775 -o -perm 750 -o -perm 711 -o -perm 555 \
  -o -perm 511 \) -exec chmod 755 {} \; -o \
 \( -perm 666 -o -perm 664 -o -perm 640 -o -perm 600 -o -perm 444 \
 -o -perm 440 -o -perm 400 \) -exec chmod 644 {} \;

./install \
  --prefix /usr \
  --repackage $PKG/usr

if [ -n "$LIBDIRSUFFIX" ]; then
  mv $PKG/usr/lib $PKG/usr/lib$LIBDIRSUFFIX
  sed -i "s,/lib/,/lib$LIBDIRSUFFIX/," $PKG/usr/bin/$PRGNAM
fi

# Creamos una configuracion basica
cd $PKG/$HOME/.opera
cat > operaprefs.ini << "EOF"
Opera Preferences version 2.1
; Do not edit this file while Opera is running
; This file is stored in UTF-8 encoding

[State]
Detected Country Code=ES
Active Country Code=ES
Active Region=es
Active Default Language=es-ES
Accept License=1
Data1=00c0dd1ab85ad7bae88e381950c9cfaf2cf
Data3=00c0dd1ab85ad7bae88e381950c9cfaf2cf
Country Check=0
Total Uptime=67
Run=0

[User Prefs]
Language Files Directory=
Preferences Version=6
Enable Usage Statistics=0
Address Search Drop Down Weighted Width=2496
Google TLD Default=.google.es
Google TLD Downloaded=1
Home URL=http://foro.seguridadwireless.net/
Startup Type=2

[Install]
Newest Used Version=12.16.1860
Newest Used Beta Name=
First Used Version=12.16.1860
First Run Timestamp=1405647496

[Auto Update]
Country Code=ES

[Proxy]
Opera Turbo Config File={Resources}region/es/turbosettings.xml

[Windows]
License Dialog=447,154,472,460,0
Browser Window=50,50,1266,633,2
New Preferences Dialog=310,100,740,507,0
Document Window=0,0,1366,665,2
EOF
}

###################################
## BLOQUE PRINCIPAL DE EJECUCION ##
###################################
# Si se cierra el script inesperadamente, ejecutar la funcion de limpieza
trap f_exitmode SIGHUP SIGINT

#Inicializamos las variables globales
f_variables
#Comprobamos conexion a Internet
f_comprobarConexion
#Inicializamos las variables del script
F_variables
#Creamos directorio de trabajo
f_directorioTemporal
#Creamos directorios extra
F_extradirs
#Mostramos el mensaje de presentacion
f_presentacion
#Comprobamos updates del script
f_comprobarUpdates
#Comprobamos version instalada del script
f_versionInstalada
#Si no existe el fichero se descargara
F_download
#Descomprimir fichero descargado y compilamos
F_compilar
#Hacemos strip sobre el paquete
f_strip
#Creamos xzm , instalamos y salimos
f_tareasFinales