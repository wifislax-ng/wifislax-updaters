#!/bin/sh

# Script by www.seguridadwireless.net

SCRIPT_VERSION=20160211

############################################################
## Funciones comunes. Su nombre empieza por f_ ##
############################################################
f_variables(){
	. /opt/wifislax-updaters/Funciones/funciones_updater
}


############################################################
## Funciones propias del script. Su nombre empieza por F_ ##
############################################################
# Definicion de variables
F_variables() {
	PRGNAM=metasploit
	echo -ne "\033]2;${PRGNAM}_updater\007"
	WEB="https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=metasploit"
	VERSION=`curl -s $WEB|grep pkgver|head -1|cut -d '>' -f4|cut -d '<' -f-1`
	DESCARGA=http://downloads.metasploit.com/data/releases/metasploit-latest-linux-installer.run
	BASEINSTDIR="opt"
	INSTDIR="$BASEINSTDIR/metasploit"
	PG_UID=${PG_UID:-209}
	PG_GID=${PG_GID:-209}
	PG_PORT=${PG_PORT:-7175}
	INITSCRIPT=metasploit
}

# Creamos directorios extra
F_extradirs(){
mkdir -p $PKG/{$BASEINSTDIR,etc/rc.d,usr/bin,usr/share/pixmaps,usr/share/applications/wifislax/Testing}
}

# Comprobar dependencias
F_dependencias(){
	if [ -d /opt/metasploit ]; then
	rm -rf /opt/metasploit
	fi
	PROCESO=$(ps aux | grep '[p]ostgres.bin' | awk '{print $2}')
	PROCESO1=$(ps aux | grep '[n]ginx.conf' | awk '{print $2}')
	PROCESO2=$(ps aux | grep '[.]ruby.bin' | awk '{print $2}')
	if [ ! -z $PROCESO ]; then
	kill $(ps aux | grep '[p]ostgres.bin' | awk '{print $2}')
	fi
	if [ ! -z $PROCESO1 ]; then
	kill $(ps aux | grep '[n]ginx.conf' | awk '{print $2}')
	fi
	if [ ! -z $PROCESO2 ]; then
	kill $(ps aux | grep '[.]ruby.bin' | awk '{print $2}')
	fi
}

# Si el paquete no existe se descargara de internet
F_download(){
	if [ ! -f $TMP/metasploit-latest-linux-installer.run ]; then
	echo ""
	echo "$CYAN"Descargando sources de $PRGNAM-$VERSION"$CIERRE"
	sleep 1
	aria2c -x 3 $DESCARGA
	cd $TMP
	chmod 755 metasploit-latest-linux-installer.run
	fi
}

# Descomprimimos el fichero descargado y compilamos
F_compilar(){
echo ""
echo "$VERDE""Instalando Metasploit Framework"$BLANCO"..."$CIERRE""
echo ""
echo "$VERDE""Este proceso puede tardar un par de minutos , se paciente"$BLANCO"..."$CIERRE""
echo ""
chown root:root metasploit-latest-linux-installer.run
chmod 755 metasploit-latest-linux-installer.run

./metasploit-latest-linux-installer.run \
  --mode unattended \
  --unattendedmodeui none \
  --postgres_port $PG_PORT
  
# Detenemos metasploit si esta en ejecucion
echo ""
echo ""$ROJO"Parando Metasploit Framework"$BLANCO"..."$CIERRE""
echo ""

if ! /etc/init.d/$INITSCRIPT stop; then
	echo ""
	echo ""$AMARILLO"Esperando a PostgreSQL para terminar"$BLANCO"..."$CIERRE""
	echo ""
	PSPID=$(head -1 /$INSTDIR/postgresql/data/postmaster.pid)
	while kill -0 $PSPID 2>/dev/null; do
		sleep 1;
	done
fi

	mv /$INSTDIR $PKG/$BASEINSTDIR/
	
# Creamos un script de inicio para el servicio metasploit eliminando todos loq ue genera el instalador S80metasploit
	
	rm -f /etc/rc.d/rc?.d/S80metasploit /etc/rc.d/rc?.d/K30metasploit
	mv /etc/init.d/$INITSCRIPT $PKG/etc/rc.d/rc.$INITSCRIPT.new
	chown root:root $PKG/etc/rc.d/rc.$INITSCRIPT.new
	chmod 755 $PKG/etc/rc.d/rc.$INITSCRIPT.new
	chmod -x $PKG/$INSTDIR/apps/pro/ui/scripts/ctl.sh
	chmod -x $PKG/$INSTDIR/apps/pro/engine/scripts/ctl.sh
	chmod -x $PKG/$INSTDIR/apps/pro/ui/scripts/worker_ctl.sh
	
# Creamos simbolicos
	mkdir -p $PKG/usr/bin
	( cd $PKG/usr/bin
	for file in $(ls ../../$INSTDIR/app/msf*); do
	ln -sf $file $(basename $file)
	done
	)
	
	ln -s apps/pro/msf3 $PKG/$INSTDIR/msf3

# Renombramos el servicio de inicio
	mv -f $PKG/etc/rc.d/rc.metasploit.new $PKG/etc/rc.d/rc.metasploit
	
# Generamos el icono usando base64 gracias vk489 por enseÃ±arme esto
echo "
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
" | base64 -d >/$PKG/usr/share/pixmaps/$PRGNAM.png

# Generamos un fichero desktop
echo "[Desktop Entry]
Categories=testing;
Exec=msfconsole
Icon=metasploit
MimeType=
Name=Metasploit Konsole
Path=
StartupNotify=true
Terminal=true
TerminalOptions=
Type=Application" > $PKG/usr/share/applications/wifislax/Testing/Metasploit_Konsole.desktop

# Antes de generar el modulo eliminamos el .run por si nos quedamos sin espacio
rm -rf $TMP/metasploit-latest-linux-installer.run	
}

###################################
## BLOQUE PRINCIPAL DE EJECUCION ##
###################################
# Si se cierra el script inesperadamente, ejecutar la funcion de limpieza
trap f_exitmode SIGHUP SIGINT

#Inicializamos las variables globales
f_variables
#Comprobamos conexion a Internet
f_comprobarConexion
#Inicializamos las variables del script
F_variables
#Creamos directorio de trabajo
f_directorioTemporal
# Creamos directorios extra
F_extradirs
#Mostramos el mensaje de presentacion
f_presentacion
#Comprobamos updates del script
f_comprobarUpdates
#Asignamos o detectamos arquitectura
f_arquitectura
#Comprobamos version instalada del paquete
f_versionInstalada
#Compronar dependencias
F_dependencias
#Si no existe el fichero se descargara
F_download
#Descomprimir fichero descargado y compilamos
F_compilar
#Creamos xzm , instalamos y salimos
f_tareasFinales